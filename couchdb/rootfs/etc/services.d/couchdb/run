#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start the CouchDB service
# s6-overlay docs: https://github.com/just-containers/s6-overlay
# ==============================================================================

# Declare variables
declare port
declare username
declare password

# Get configuration
port=$(bashio::config 'port')
username=$(bashio::config 'username')
password=$(bashio::config 'password')

# Validate password is provided
if bashio::var.is_empty "${password}"; then
    bashio::log.fatal "Password is required for CouchDB!"
    bashio::exit.nok
fi

bashio::log.info "Starting CouchDB..."
bashio::log.info "Port: ${port}"
bashio::log.info "Username: ${username}"

# Create CouchDB configuration
mkdir -p /opt/couchdb/etc/local.d

# Configure CouchDB port and bind address
cat > /opt/couchdb/etc/local.d/99-addon.ini << EOF
[chttpd]
port = ${port}
bind_address = 0.0.0.0

[admins]
${username} = ${password}

[couchdb]
single_node=true
database_dir = /config/couchdb/data
view_index_dir = /config/couchdb/data

[httpd]
bind_address = 0.0.0.0

[couch_peruser]
enable = true

[log]
file = /config/couchdb/log/couchdb.log
EOF

# Create data directories in /config for persistence
mkdir -p /config/couchdb/{data,config,log}
chown -R couchdb:couchdb /config/couchdb
chown -R couchdb:couchdb /opt/couchdb/etc

# Start CouchDB
bashio::log.info "Starting CouchDB database server..."
export COUCHDB_USER="${username}"
export COUCHDB_PASSWORD="${password}"
cd /opt/couchdb
exec s6-setuidgid couchdb /opt/couchdb/bin/couchdb